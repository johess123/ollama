<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .chat-icon { /*èŠå¤©æŒ‰éˆ•åœ–ç¤º*/
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .chat-window { /*èŠå¤©è¦–çª—*/
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 450px;
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            background-color: white;
        }
        .chat-window.active {
            display: flex;
            flex-direction: row;
        }
        .chat-sidebar { /*å·¦å´*/
            width: 120px;
            background-color: #f1f1f1;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            font-size: 15px;
        }
        .chat-sidebar-item { /*èŠå¤©è¨˜éŒ„æ¬„*/
            padding: 15px;
            cursor: pointer;
        }
        .chat-sidebar-item:hover {
            background-color: #ddd;
        }
        .new-chat {
            padding: 15px;
            cursor: pointer;
        }
        .new-chat:hover {
            background-color: #ddd;
        }
        .chat-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-messages-div {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            width: 330px;
            height: 460px;
            /* padding: 10px; */
        }
        .chat-messages {
            display: flex;
            flex-direction: column;
        }
        .user, .assistant, .upload-file-message {
            /*display: flex;  è¨­ç½®ç‚º inline-blockï¼Œä½¿å¯¬åº¦é©æ‡‰å…§å®¹ */
            padding: 10px;
            border-radius: 10px; /* åœ“è§’é‚Šæ¡† */
            margin-top: 10px;
            margin-bottom: 10px;
            max-width: 60%; /* è¨Šæ¯æ¡†æœ€å¤§å¯¬åº¦ */
            word-wrap: break-word; /* è‡ªå‹•æ›è¡Œ */
        }
        .user {
            align-self: flex-end; /* å°‡userè¨Šæ¯ç§»å‹•åˆ°å³é‚Š */
            background-color: #007bff;
            color: white;
            text-align: right;
            margin-left: auto;
            margin-right: 10px; /* èˆ‡å³é‚Šç•Œçš„è·é›¢ */
        }
        .assistant {
            align-self: flex-start; /* å°‡assistantè¨Šæ¯ç§»å‹•åˆ°å·¦é‚Š */
            background-color: #f4f4f4;
            text-align: left;
            margin-left: 10px; /* èˆ‡å·¦é‚Šç•Œçš„è·é›¢ */
        }
        .upload-file-message {
            flex-wrap: nowrap;
            align-self: flex-end; /* å°‡assistantè¨Šæ¯ç§»å‹•åˆ°å·¦é‚Š */
            text-align: right;
            margin-left: auto;
            margin-right: 10px; /* èˆ‡å³é‚Šç•Œçš„è·é›¢ */
            background-color: #f4f4f4;
            display: none;
            align-items: center;
            font-weight: bold;
        }
        .upload-file-icon {
            background-color: #ff00a6;
            color: white;
            padding: 10px;
            border-radius: 10px; /* åœ“è§’é‚Šæ¡† */
        }
        .chat-input {
            display: flex;
            border-top: 1px solid #ccc;
            /* height: 40px; */
            align-items: center;
        }
        #send_form{
            display: flex;
            align-items: center;
        }
        .chat-input-field {
            border: none;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            width: 210px;
        }
        .chat-input-sender {
            border: none;
            border-radius: 10px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-right: 5px; /* èˆ‡è¨Šæ¯å…§å®¹çš„è·é›¢ */
            width: 55px;
            height: 40px;
        }
        .chat-upload {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            cursor: pointer;
            background-color: #f1f1f1;
            width: 20px;
        }
        .loading-message {
            align-self: flex-start; /* å°‡assistantè¨Šæ¯ç§»å‹•åˆ°å·¦é‚Š */
            background-color: #f4f4f4;
            text-align: left;
            margin-left: 5px; /* èˆ‡å·¦é‚Šç•Œçš„è·é›¢ */
            font-size: 15px;
            font-weight: bold;
            display: inline-block;
            animation: bounce 0.6s infinite alternate;
        }
        #chat_file {
            display: none;
        }
        #chat_file_label {
            cursor: pointer;
        }
        @keyframes bounce {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body>
    <div class="chat-icon" id="chatIcon">ğŸ’¬</div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-sidebar" id="chatSidebar">
            {% for chat in record %}
                <div class="chat-sidebar-item" id="{{chat[0]}}" onclick="load_chat(this.id)">{{chat[1]}}</div>
            {% endfor %}
            <div class="new-chat" id="new-chat" onclick="create_chat()">
                æ–°å¢èŠå¤©
            </div>
        </div>
        <div class="chat-content">
            <div class="chat-messages-div" id="chatMessagesDiv">
                <div class="chat-messages" id="chatMessages"></div>
            </div>
            <div class="chat-input">
                <form id="send_form">
                    <div class="chat-upload">
                        <label for="chat_file" id="chat_file_label">ğŸ“</label>
                        <input type="file" id="chat_file" accept=".txt, .pdf">
                    </div>
                    <textarea class="chat-input-field" placeholder="Type a message..." id="query"></textarea>
                    &nbsp;
                    <input id="chatSendButton" class="chat-input-sender" type="submit" value="Send"/>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.umd.min.js"></script>
    <script>
        var chat_id = "new_chat";
        var lock = false; // å‚³é€è¨Šæ¯ä¸­ç„¡æ³•æ–°å¢èŠå¤©ã€åˆ‡æ›èŠå¤©å®¤ã€é‡è¤‡å‚³é€è¨Šæ¯
        var file_lock = false; // ä¸Šå‚³æª”æ¡ˆ lock
        document.getElementById('chatIcon').addEventListener('click', function() {
            var chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('active');
        });
        function load_chat(load_chat_id) { // è®€å–èŠå¤©ç´€éŒ„
            if (lock == false) {
                chat_id = load_chat_id;
                fetch('http://192.168.28.226:5001/load_chat', {
                // fetch('https://33b9-101-9-133-94.ngrok-free.app/load_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({chat_id: chat_id})
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data.result);
                    chat_messages = document.getElementById('chatMessages');
                    chat_messages.innerHTML = '';
                    data.result.forEach(message => {
                        if (message.role == 'file') {
                            console.log('file');
                            addUploadFileMessage(message.content);
                        } else {
                            messageDiv = document.createElement('div');
                            messageDiv.className = message.role; // è¨­ç½® class ç‚º 'user' æˆ– 'assistant'
                            messageDiv.textContent = message.content; // è¨­ç½®è¨Šæ¯å…§å®¹
                            chat_messages.appendChild(messageDiv); // å°‡æ–°å…ƒç´ åŠ å…¥ chatMessages
                        }
                    });
                    scrollToBottom();
                })
            }
        }
        function scrollToBottom() {
            chatMessagesDiv = document.getElementById("chatMessagesDiv");
            chatMessagesDiv.scrollTop = chat_messages.scrollHeight;
        }
        document.getElementById("send_form").addEventListener('submit',function(event) { // é€å‡ºè¨Šæ¯
            event.preventDefault();
            if (lock == false) {
                // é¡¯ç¤ºä½¿ç”¨è€…å•é¡Œæ–¼èŠå¤©å®¤
                query = document.getElementById('query').value;
                document.getElementById('query').value = "";
                chat_messages = document.getElementById('chatMessages');
                messageDiv = document.createElement('div');
                messageDiv.className = "user";
                messageDiv.textContent = query; // è¨­ç½®è¨Šæ¯å…§å®¹
                chat_messages.appendChild(messageDiv); // å°‡æ–°å…ƒç´ åŠ å…¥ chatMessages
                lock = true;
                // é¡¯ç¤ºç­‰å¾…å‹•ç•«
                loading_message = document.createElement('div');
                loading_message.className = "loading-message";
                loading_message.id = "loading_message";
                chat_messages.appendChild(loading_message);
                loading_message = document.getElementById('loading_message')
                loading_message.textContent = "â€¢â€¢â€¢";
                loading_message.style.display = 'inline-block';
                // ç•«é¢ç§»è‡³æœ€ä¸‹é¢
                scrollToBottom();
                // å‚³é€è¨Šæ¯
                var formData = new FormData();
                formData.append('query', query);
                formData.append('chat_id', chat_id);
                formData.append('user', 'kenny');
                formData.append('user_id', 1);
                // æ˜¯å¦æœ‰ä¸Šå‚³æª”æ¡ˆ
                var fileInput = document.getElementById('chat_file');
                var file = fileInput.files[0];
                if (file) {
                    formData.append('file', file);
                }
                fetch('http://192.168.28.226:5001/chat', {
                // fetch('https://33b9-101-9-133-94.ngrok-free.app/chat', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥æ¬„
                    fileInput.value = '';
                    // é—œé–‰ç­‰å¾…å‹•ç•«
                    loading_message.remove();
                    lock = false;
                    messageDiv = document.createElement('div');
                    messageDiv.className = "assistant";
                    messageDiv.textContent = data.result; // è¨­ç½®è¨Šæ¯å…§å®¹
                    chat_messages.appendChild(messageDiv); // å°‡æ–°å…ƒç´ åŠ å…¥ chatMessages
                    if ('chat_name' in data) { // æ–°èŠå¤©æœƒå›å‚³èŠå¤©å®¤åç¨±
                        chat_sidebar = document.getElementById('chatSidebar');
                        new_chat = document.getElementById("new-chat");
                        if (new_chat) {
                            chat_sidebar.removeChild(new_chat);
                        }
                        chat = document.createElement("div");
                        chat_id = data.chat_id;
                        chat.id = chat_id;
                        chat.className = "chat-sidebar-item"
                        title = data.chat_name;
                        if (title.length >15) {
                            title = title.substring(0,12);
                            title += "..."
                        }
                        chat.textContent = title;
                        chat.setAttribute("onclick", "load_chat(this.id)");
                        chat_sidebar.insertBefore(chat, chat_sidebar.firstChild);

                        new_chat = document.createElement("div");
                        new_chat.id = "new-chat";
                        new_chat.className = "new-chat"
                        new_chat.textContent = "æ–°å¢èŠå¤©";
                        chat_sidebar.appendChild(new_chat);
                        new_chat.setAttribute("onclick", "create_chat()");
                    }
                    scrollToBottom();
                })
                .catch(error => {
                    console.error('Error generating text:', error);
                });
            }
        });
        function create_chat() { // æ–°å¢èŠå¤©
            if (lock == false) {
                chat_messages = document.getElementById('chatMessages');
                chat_messages.innerHTML = '';
                chat_id = "new_chat";
                uploadFileMessage = document.querySelectorAll('.upload-file-message');
                uploadFileMessage.forEach(element => {
                    element.remove();
                });
                file_lock = false;
            }
        }
        document.getElementById('chat_file').addEventListener('change', function(event) { // ä¸Šå‚³æª”æ¡ˆ
            if (file_lock == false) {
                file_lock = true;
                var file = event.target.files[0];
                file_name = file.name;
                addUploadFileMessage(file_name);
                scrollToBottom();
            }
        });
        function addUploadFileMessage(file_name) { // æ–°å¢æª”æ¡ˆè¨Šæ¯
            // å¤–å±¤ div
            let uploadFileMessage = document.createElement('div');
            uploadFileMessage.className = 'upload-file-message';
            uploadFileMessage.id = 'uploadFileMessage'+file_name;
            uploadFileMessage.title = file_name;

            // upload-file-icon div
            let uploadFileIcon = document.createElement('div');
            uploadFileIcon.className = 'upload-file-icon';
            uploadFileIcon.id = 'uploadFileIcon'+file_name;
            uploadFileMessage.appendChild(uploadFileIcon);

            // æ·»åŠ ç©ºæ ¼
            let space = document.createTextNode('\u00A0');
            uploadFileMessage.appendChild(space);

            // upload-file-name div
            let uploadFileName = document.createElement('div');
            uploadFileName.className = 'upload-file-name';
            uploadFileName.id = 'uploadFileName'+file_name;
            uploadFileMessage.appendChild(uploadFileName);

            // åŠ åˆ° chat message
            document.getElementById('chatMessages').appendChild(uploadFileMessage);
            
            // é¡¯ç¤º
            document.getElementById('uploadFileMessage'+file_name).style.display = 'flex';
            
            // ç¸®çŸ­æª”å
            if (file_name.length > 11) {
                file_short_name = file_name.substring(0,6)
                lastDot = file_name.lastIndexOf('.');
                file_type = "";
                if (lastDot != -1) {
                    file_type =  file_name.substring(lastDot);
                }
                file_new_name = file_short_name+"... "+file_type;
                document.getElementById('uploadFileName'+file_name).textContent = file_new_name;
                document.getElementById('uploadFileIcon'+file_name).textContent = "File";
            } else {
                document.getElementById('uploadFileName'+file_name).textContent = file_name;
                document.getElementById('uploadFileIcon'+file_name).textContent = "File";
            }
        }

    </script>
</body>
</html>
